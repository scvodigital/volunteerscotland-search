{
  "size": 10000,
  "_source": [
    "Id",
    "title",
    "organisation_name",
    "closing_date",
    "geo_coords",
    "slug"
  ],
  "query": {
    "bool": {
      "filter": [
        {{>queries_opportunity_common_filters request.params.query}},
        {{>queries_opportunity_search_filters request.params.query}}
      ],
      "must": [
        {{>queries_opportunity_search_must request.params.query}}
      ]
    }
  },
  "aggs": {
    "geo_search": {
      "geo_distance": {
        "field": "geo_coords",
        "origin": "{{@root.request.params.query.lat}}, {{@root.request.params.query.lng}}",
        "unit": "mi",
        "ranges": [
          {
            "to": {{@root.request.params.query.distance}}
          },
          {
            "from": {{@root.request.params.query.distance}}
          }
        ]
      }
    }
  },
  "sort": [
    {{#ifAll @root.request.params.query.location @root.request.params.query.lat @root.request.params.query.lng ~}}
      {
        "_geo_distance": {
          "geo_coords": {
            "lat": {{@root.request.params.query.lat}},
            "lon": {{@root.request.params.query.lng}}
          },
          "order": "asc",
          "unit": "mi",
          "mode": "min",
          "distance_type": "arc"
        }
      }
    {{/ifAll ~}}
  ]
}
