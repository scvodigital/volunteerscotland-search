{{#withExtend this settings=@root.request.params.query}}
  <div class="container-fluid container-content content-page">
    <h2>Search widget builder</h2>
    <form id="widget-builder">
      <p class="mdc-typography--body1">
        Please choose a widget type and optional location filter.
      </p>
      <div class="mdc-layout-grid">
        <div class="mdc-layout-grid__inner">
          <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-9-desktop mdc-layout-grid__cell--span-9-tablet mdc-layout-grid__cell--span-4-phone">
            <div class="mdc-select" data-mdc-auto-init="MDCSelect">
              <span class="mdc-select__dropdown-icon"></span>
              <select class="mdc-select__native-control" id="type" name="type">
                <option value="opportunities"{{#compare settings.type "opportunities"}} selected{{/compare}}>Volunteering opportunities</option>
                <option value="organisations-all"{{#compare settings.type "organisations-all"}} selected{{/compare}}>Volunteering organisations</option>
              </select>
              <label class="mdc-floating-label" for="type">
                Widget type
              </label>
              <div class="mdc-line-ripple"></div>
            </div>
            <div class="mdc-select" data-mdc-auto-init="MDCSelect">
              <span class="mdc-select__dropdown-icon"></span>
              <select class="mdc-select__native-control" id="filter" name="filter">
                <option value="all">All of Scotland (no filter)</option>
                <option value="aberdeen-city"{{#compare settings.filter "aberdeen-city"}} selected{{/compare}}>Aberdeen</option>
                <option value="aberdeenshire"{{#compare settings.filter "aberdeenshire"}} selected{{/compare}}>Aberdeenshire</option>
                <option value="angus"{{#compare settings.filter "angus"}} selected{{/compare}}>Angus</option>
                <option value="argyll-and-bute"{{#compare settings.filter "argyll-and-bute"}} selected{{/compare}}>Argyll and Bute</option>
                <option value="clackmannanshire"{{#compare settings.filter "Clackmannanshire"}} selected{{/compare}}>Clackmannanshire</option>
                <option value="dumfries-and-galloway"{{#compare settings.filter "dumfries-and-galloway"}} selected{{/compare}}>Dumfries and Galloway</option>
                <option value="dundee-city"{{#compare settings.filter "dundee-city"}} selected{{/compare}}>Dundee</option>
                <option value="east-ayrshire"{{#compare settings.filter "east-ayrshire"}} selected{{/compare}}>East Ayrshire</option>
                <option value="east-dunbartonshire"{{#compare settings.filter "east-dunbartonshire"}} selected{{/compare}}>East Dunbartonshire</option>
                <option value="east-lothian"{{#compare settings.filter "east-lothian"}} selected{{/compare}}>East Lothian</option>
                <option value="east-renfrewshire"{{#compare settings.filter "east-renfrewshire"}} selected{{/compare}}>East Renfrewshire</option>
                <option value="edinburgh-city"{{#compare settings.filter "edinburgh-city"}} selected{{/compare}}>Edinburgh</option>
                <option value="falkirk"{{#compare settings.filter "falkirk"}} selected{{/compare}}>Falkirk</option>
                <option value="fife"{{#compare settings.filter "fife"}} selected{{/compare}}>Fife</option>
                <option value="glasgow-city"{{#compare settings.filter "glasgow-city"}} selected{{/compare}}>Glasgow</option>
                <option value="highland"{{#compare settings.filter "highland"}} selected{{/compare}}>Highland</option>
                <option value="inverclyde"{{#compare settings.filter "inverclyde"}} selected{{/compare}}>Inverclyde</option>
                <option value="midlothian"{{#compare settings.filter "midlothian"}} selected{{/compare}}>Midlothian</option>
                <option value="moray"{{#compare settings.filter "moray"}} selected{{/compare}}>Moray</option>
                <option value="western-isles"{{#compare settings.filter "western-isles"}} selected{{/compare}}>Na h-Eileanan Siar (Western Isles)</option>
                <option value="north-ayrshire"{{#compare settings.filter "north-ayrshire"}} selected{{/compare}}>North Ayrshire</option>
                <option value="north-lanarkshire"{{#compare settings.filter "north-lanarkshire"}} selected{{/compare}}>North Lanarkshire</option>
                <option value="orkney-islands"{{#compare settings.filter "orkney-islands"}} selected{{/compare}}>Orkney</option>
                <option value="perth-and-kinross"{{#compare settings.filter "perth-and-kinross"}} selected{{/compare}}>Perth and Kinross</option>
                <option value="renfrewshire"{{#compare settings.filter "renfrewshire"}} selected{{/compare}}>Renfrewshire</option>
                <option value="scottish-borders"{{#compare settings.filter "scottish-borders"}} selected{{/compare}}>Scottish Borders</option>
                <option value="shetland-islands"{{#compare settings.filter "shetland-islands"}} selected{{/compare}}>Shetland</option>
                <option value="south-ayrshire"{{#compare settings.filter "south-ayrshire"}} selected{{/compare}}>South Ayrshire</option>
                <option value="south-lanarkshire"{{#compare settings.filter "south-lanarkshire"}} selected{{/compare}}>South Lanarkshire</option>
                <option value="stirling"{{#compare settings.filter "stirling"}} selected{{/compare}}>Stirling</option>
                <option value="west-dunbartonshire"{{#compare settings.filter "west-dunbartonshire"}} selected{{/compare}}>West Dunbartonshire</option>
                <option value="west-lothian"{{#compare settings.filter "west-lothian"}} selected{{/compare}}>West Lothian</option>
              </select>
              <label class="mdc-floating-label" for="filter">
                Search filter
              </label>
              <div class="mdc-line-ripple"></div>
            </div>
            <div class="mdc-layout-grid colorwells">
              <div class="mdc-layout-grid__inner">
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-4-phone">
                  <div class="mdc-text-field mdc-text-field--box" data-mdc-auto-init="MDCTextField">
                    <input id="colour_primary" name="colour_primary" type="text" maxlength="7" class="colorwell mdc-text-field__input mdc-text-field--fullwidth"
                        value="{{default settings.colour_primary '#00a0af'}}" data-lpignore="true" />
                    <label class="mdc-floating-label" id="colour_primary_label" for="colour_primary">
                      Colour (primary)
                    </label>
                  </div>
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-4-phone">
                  <div class="mdc-text-field mdc-text-field--box" data-mdc-auto-init="MDCTextField">
                    <input id="colour_secondary" name="colour_secondary" type="text" maxlength="7" class="colorwell mdc-text-field__input mdc-text-field--fullwidth"
                        value="{{default settings.colour_secondary '#387c2c'}}" data-lpignore="true" />
                    <label class="mdc-floating-label" id="colour_secondary_label" for="colour_secondary">
                      Colour (secondary)
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="mdc-form-field">
              <div class="mdc-checkbox" data-mdc-auto-init="MDCCheckbox">
                <input type="checkbox" class="mdc-checkbox__native-control" name="no_conflict" id="no_conflict" value="off"
                    {{#if (compare settings.no_conflict 'on')}}checked{{/if}}/>
                <div class="mdc-checkbox__background">
                  <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                    <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                  </svg>
                  <div class="mdc-checkbox__mixedmark"></div>
                </div>
              </div>
              <label for="no_conflict">Use a "No conflict" version of the widget</label>
            </div>
            <p class="mdc-typography--body2 t-margin-none">
              In the unlikely instance that you run into any problems caused by conflicting Javascript modules on the page you
              are embedding the widget check this box.
            </p>
            <div class="mdc-form-field">
              <div class="mdc-checkbox" data-mdc-auto-init="MDCCheckbox">
                <input type="checkbox" class="mdc-checkbox__native-control" name="enable_mva" id="enable_mva" value="on"
                    {{#unless (compare settings.enable_mva 'off')}} checked{{/unless}} />
                <div class="mdc-checkbox__background">
                  <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                    <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                  </svg>
                  <div class="mdc-checkbox__mixedmark"></div>
                </div>
              </div>
              <label for="enable_mva">Use 'My Volunteer Account' to register interest for opportunities</label>
            </div>
            <p class="mdc-typography--body2 t-margin-none">
              My Volunteer Account allows volunteers to easily manage their own profile and save opportunities for later, and
              enables better tracking of opportunity registrations for TSIs and VIOs. If you choose not to use this option,
              the volunteer will be provided with the contact email for the opportunity.
            </p>
          </div>
          <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet mdc-layout-grid__cell--span-4-phone">
            <div id="colorpicker"></div>
          </div>
        </div>
      </div>
      <button class="mdc-button mdc-button--raised mdc-button--large mdc-button--fullwidth mdc-ripple-surface mdc-ripple-surface--primary mdc-ripple-upgraded"
          type="submit" data-mdc-auto-init="MDCRipple">
        <span class="far fa-cog fa-fw mdc-list-item__graphic" aria-hidden="true"></span>
        Generate
      </button>
    </form>

    <div id="widget-preview-panel" style="display: none;">
      <h3>How to embed the widget</h3>
      <p class="mdc-typography--body1">
        Please use the following code to embed the specified search widget on your own website:
      </p>
      <div class="embed copyable" id="code"></div>
      <button class="btn copy js-copy-code-btn" data-source="embed" unselectable="on">
        <span class="fal fa-clipboard" aria-hidden="true"></span>
        Copy
      </button>

      <h3>Preview</h3>
      <div id="widget-preview"></div>
    </div>
    <script type="text/javascript">
      function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          var successful = document.execCommand('copy');
          var msg = successful ? 'successful' : 'unsuccessful';
          console.log('Fallback: Copying text command was ' + msg);
        } catch (err) {
          console.error('Fallback: Oops, unable to copy', err);
        }

        document.body.removeChild(textArea);
      }
      function copyTextToClipboard(text) {
        if (!navigator.clipboard) {
          fallbackCopyTextToClipboard(text);
          return;
        }
        navigator.clipboard.writeText(text).then(function() {
          console.log('Async: Copying to clipboard was successful!');
        }, function(err) {
          console.error('Async: Could not copy text: ', err);
        });
      }

      var copyCodeBtn = document.querySelector('.js-copy-code-btn');

      copyCodeBtn.addEventListener('click', function(event) {
        copyTextToClipboard($('#code')[0].innerText);
      });

      document.querySelector('#widget-builder').addEventListener('submit', function(evt) {
        evt.preventDefault();
        updateScriptTags();
      });

      function updateScriptTags() {
        $('#widget-preview-panel').css('display', 'block');
        $('#widget-preview').empty();
        window.location.hash = '';

        var type = $('#type').val();
        var filter = $('#filter').val();
        var colour_primary = $('#colour_primary').val();
        var colour_secondary = $('#colour_secondary').val();
        var no_conflict = $('#no_conflict').is(':checked');
        var enable_mva = $('#enable_mva').is(':checked');

        var widgetSrc = 'https://widget.search.volunteerscotland.net/' + (no_conflict ? 'no-conflict-' : '') + 'widget.js';
        var dataUrl = 'https://search.volunteerscotland.net/widget/' + type;

        if (window.location.hostname === 'volunteerscotland-search.local') {
          widgetSrc = widgetSrc.replace('widget.search.volunteerscotland.net', 'volunteerscotland-search.local:9000');
          dataUrl = dataUrl.replace('search.volunteerscotland.net', 'volunteerscotland-search.local:8080');
        }

        var scriptTag = $('<script>').attr({
          'src': widgetSrc,
          'data-url': dataUrl
        });

        if (filter && filter !== 'all') {
          scriptTag.attr('data-tsi', filter);
        }

        if (colour_primary && colour_primary !== "#00a0af") {
          scriptTag.attr('data-colour-primary', colour_primary);
        }

        if (colour_secondary && colour_secondary !== "#387c2c") {
          scriptTag.attr('data-colour-secondary', colour_secondary);
        }

        if (type === 'opportunities' && !enable_mva) {
          scriptTag.attr('data-disable-mva', 'true');
        }

        var scriptTagHtml = scriptTag[0].outerHTML;
        $('#code').text(scriptTagHtml);

        scriptTag.attr('src', scriptTag.attr('src').replace('widget.js', 'no-conflict-widget.js'));
        console.log(scriptTag[0].outerHTML);
        $('#widget-preview')[0].insertAdjacentElement('afterbegin', scriptTag[0]);
      }
    </script>
  </div>
{{/withExtend}}